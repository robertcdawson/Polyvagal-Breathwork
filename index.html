<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Breathwork Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Audio Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Temporal Polyfill for iOS Safari and older browsers -->
    <script src="https://cdn.jsdelivr.net/npm/@js-temporal/polyfill@0.4.4/dist/index.umd.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Ocean Theme */
            --bg-gradient-start: #a8e0ff;
            --bg-gradient-end: #8ee3f8;
            --card-bg: rgba(255, 255, 255, 0.4);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --button-primary-bg: #3b82f6;
            --button-primary-hover: #2563eb;
            --circle-base-bg: rgba(255, 255, 255, 0.2);
            --circle-fill-color: rgba(255, 255, 255, 0.7);
            
            --phase-inhale: rgba(132, 204, 22, 0.6);
            --phase-hold-in: rgba(96, 165, 250, 0.6);
            --phase-exhale: rgba(34, 197, 94, 0.6);
            --phase-hold-out: rgba(156, 163, 175, 0.6);
        }
        .theme-forest {
            --bg-gradient-start: #D4E2D4;
            --bg-gradient-end: #A2B29F;
            --card-bg: rgba(255, 255, 255, 0.5);
            --text-primary: #2C3333;
            --text-secondary: #395144;
            --button-primary-bg: #4E6C50;
            --button-primary-hover: #395144;
            --circle-base-bg: rgba(255, 255, 255, 0.3);
            --circle-fill-color: rgba(170, 204, 170, 0.8);
            
            --phase-inhale: rgba(78, 108, 80, 0.6);
            --phase-hold-in: rgba(57, 81, 68, 0.6);
            --phase-exhale: rgba(170, 204, 170, 0.6);
            --phase-hold-out: rgba(212, 226, 212, 0.6);
        }
        .theme-cosmic {
            --bg-gradient-start: #232526;
            --bg-gradient-end: #414345;
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-primary: #F5F5F5;
            --text-secondary: #D4D4D4;
            --button-primary-bg: #8E44AD;
            --button-primary-hover: #9B59B6;
            --circle-base-bg: rgba(255, 255, 255, 0.1);
            --circle-fill-color: rgba(236, 240, 241, 0.5);
            
            --phase-inhale: rgba(155, 89, 182, 0.6);
            --phase-hold-in: rgba(142, 68, 173, 0.6);
            --phase-exhale: rgba(52, 152, 219, 0.6);
            --phase-hold-out: rgba(44, 62, 80, 0.6);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            transition: background 0.5s ease-in-out;
            color: var(--text-primary);
        }
        .main-card { background-color: var(--card-bg); }
        .btn-primary { background-color: var(--button-primary-bg); }
        .btn-primary:hover { background-color: var(--button-primary-hover); }
        #circle { background-color: var(--circle-base-bg); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #circle-fill { background-color: var(--circle-fill-color); border-radius: 50%; width: 100%; height: 100%; transform: scale(0.3); transition: none; }
        
        .phase-inhale { background-color: var(--phase-inhale) !important; }
        .phase-hold-in { background-color: var(--phase-hold-in) !important; }
        .phase-exhale { background-color: var(--phase-exhale) !important; }
        .phase-hold-out { background-color: var(--phase-hold-out) !important; }

        .preset-btn.active { background-color: var(--button-primary-bg); color: white; }
        .fade-transition { transition: opacity 0.3s ease-in-out; }

        /* WCAG 2.2: visible focus for keyboard; theme-aware */
        :focus { outline: none; }
        :focus-visible {
            outline: 2px solid var(--button-primary-bg);
            outline-offset: 2px;
        }
        .theme-cosmic :focus-visible { outline-color: #9B59B6; }

        /* Touch targets â‰¥44px (AAA); consistent control height */
        .control-height { min-height: 44px; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body class="gradient-bg">
    <main class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6" id="main-content">
        <div class="main-card w-full max-w-lg mx-auto backdrop-blur-md rounded-2xl shadow-lg p-6 md:p-8 text-center transition-colors duration-500">
            <h1 class="text-2xl md:text-3xl font-bold mb-2">Advanced Breathwork</h1>

            <section class="mb-6" aria-labelledby="breath-status-heading">
                <h2 id="breath-status-heading" class="sr-only">Breath phase and timer</h2>
                <div class="relative w-48 h-48 md:w-56 md:h-56 mx-auto mb-4 flex items-center justify-center">
                    <div id="circle" class="relative w-full h-full rounded-full shadow-inner" role="img" aria-hidden="true">
                        <div id="circle-fill" class="absolute inset-0 z-0" aria-hidden="true"></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none" aria-live="polite" aria-atomic="true">
                            <p id="instruction" class="text-2xl font-semibold fade-transition">Ready?</p>
                            <p id="timer" class="text-5xl font-bold" aria-hidden="true">-</p>
                        </div>
                    </div>
                </div>
                <p id="sessionTimeDisplay" class="h-6 mb-4 min-h-[1.5rem]" style="color: var(--text-secondary);"></p>
            </section>

            <section class="mb-8" aria-labelledby="practice-settings-heading">
                <h2 id="practice-settings-heading" class="sr-only">Practice settings</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="practiceMode" class="block mb-2">Practice By</label>
                        <select id="practiceMode" class="control-height w-full px-3 py-2 text-center bg-white/50 rounded-lg border-2 border-transparent focus:border-blue-400 focus:outline-none" aria-describedby="durationLabel">
                            <option value="cycles" selected>Cycles</option>
                            <option value="time">Time</option>
                        </select>
                    </div>
                    <div>
                        <label id="durationLabel" for="durationInput" class="block mb-2">Duration (min)</label>
                        <input type="number" id="durationInput" class="control-height w-full px-3 py-2 text-center bg-white/50 rounded-lg border-2 border-transparent focus:border-blue-400 focus:outline-none" value="5" min="1" aria-label="Session duration">
                    </div>
                </div>
                <div class="flex justify-center mb-8">
                    <div class="relative min-w-[120px] min-h-[44px]">
                        <button id="startButton" type="button" class="btn-primary absolute inset-0 w-full min-h-[44px] text-white font-bold py-3 px-6 rounded-full shadow-md transition-all transform hover:scale-105 active:scale-95" aria-label="Start breathwork session">Start</button>
                        <button id="stopButton" type="button" class="absolute inset-0 w-full min-h-[44px] bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-full shadow-md transition-all transform hover:scale-105 active:scale-95 hidden" aria-label="Stop breathwork session">Stop</button>
                    </div>
                </div>
            </section>

            <section class="mb-8" aria-labelledby="presets-heading">
                <h2 id="presets-heading" class="text-lg font-semibold border-b border-white/50 pb-2 mb-4">Presets</h2>
                <div id="presets" class="grid grid-cols-2 md:grid-cols-4 gap-2" role="group" aria-label="Breathwork technique presets">
                    <button type="button" class="preset-btn control-height p-3 bg-white/30 rounded-lg text-left" data-preset="extendedExhale">Extended Exhale</button>
                    <button type="button" class="preset-btn control-height p-3 bg-white/30 rounded-lg text-left" data-preset="boxBreathing">Box Breathing</button>
                    <button type="button" class="preset-btn control-height p-3 bg-white/30 rounded-lg text-left" data-preset="resonance">Resonance</button>
                    <button type="button" class="preset-btn control-height p-3 bg-white/30 rounded-lg text-left" data-preset="vooBreathing">VOO Breath</button>
                    <button type="button" class="preset-btn control-height p-3 bg-white/30 rounded-lg text-left md:col-span-2" data-preset="physiologicalSigh">Physiological Sigh</button>
                </div>
                <p id="preset-description" class="text-sm mt-4 min-h-[4rem] text-center flex items-center justify-center" style="color: var(--text-secondary);" aria-live="polite"></p>
            </section>

            <section id="settings" class="space-y-4 text-left" aria-labelledby="advanced-settings-heading">
                <details>
                    <summary id="advanced-settings-heading" class="font-semibold cursor-pointer control-height flex items-center rounded">Advanced Settings</summary>
                    <div class="mt-4 space-y-4">
                        <div class="flex items-center justify-between gap-4"><label for="inhale">Inhale (s)</label><input type="number" id="inhale" class="control-height w-20 p-2 text-center bg-white/50 rounded-lg" value="4" min="1" aria-label="Inhale duration in seconds"></div>
                        <div class="flex items-center justify-between gap-4"><label for="holdIn">Hold In (s)</label><input type="number" id="holdIn" class="control-height w-20 p-2 text-center bg-white/50 rounded-lg" value="2" min="0" aria-label="Hold after inhale in seconds"></div>
                        <div class="flex items-center justify-between gap-4"><label for="exhale">Exhale (s)</label><input type="number" id="exhale" class="control-height w-20 p-2 text-center bg-white/50 rounded-lg" value="8" min="1" aria-label="Exhale duration in seconds"></div>
                        <div class="flex items-center justify-between gap-4"><label for="holdOut">Hold Out (s)</label><input type="number" id="holdOut" class="control-height w-20 p-2 text-center bg-white/50 rounded-lg" value="0" min="0" aria-label="Hold after exhale in seconds"></div>
                    </div>
                </details>
            </section>

            <section class="mt-8 border-t border-white/50 pt-6" aria-labelledby="appearance-heading">
                <h2 id="appearance-heading" class="sr-only">Appearance and audio</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="themeSelector" class="block mb-2">Theme</label>
                        <select id="themeSelector" class="control-height w-full px-3 py-2 text-center bg-white/50 rounded-lg" aria-label="Color theme">
                            <option value="default">Ocean</option>
                            <option value="theme-forest">Forest</option>
                            <option value="theme-cosmic">Cosmic</option>
                        </select>
                    </div>
                    <div>
                        <label for="audioToggle" class="block mb-2">Audio Cues</label>
                        <button type="button" id="audioToggle" class="control-height w-full px-3 py-2 bg-white/30 rounded-lg" aria-pressed="false" aria-label="Toggle audio cues for breath phases">OFF</button>
                    </div>
                </div>
            </section>

            <section id="historySection" class="mt-8" aria-labelledby="history-heading">
                <h2 id="history-heading" class="sr-only">Practice history</h2>
                <button type="button" id="historyButton" class="font-semibold control-height px-2 flex items-center rounded" aria-expanded="false" aria-controls="historyLog">Practice History</button>
                <div id="historyLog" class="hidden mt-4 text-left text-sm space-y-2 max-h-48 overflow-y-auto" role="region" aria-labelledby="history-heading">
                    <p>Loading history...</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const getEl = (id) => document.getElementById(id);
        const UIElements = {
            body: document.body,
            circleFill: getEl('circle-fill'),
            instruction: getEl('instruction'),
            timer: getEl('timer'),
            startButton: getEl('startButton'),
            stopButton: getEl('stopButton'),
            settings: getEl('settings'),
            presetsDiv: getEl('presets'),
            presetDescription: getEl('preset-description'),
            durationInput: getEl('durationInput'),
            durationLabel: getEl('durationLabel'),
            sessionTimeDisplay: getEl('sessionTimeDisplay'),
            practiceMode: getEl('practiceMode'),
            themeSelector: getEl('themeSelector'),
            audioToggle: getEl('audioToggle'),
            historySection: getEl('historySection'),
            historyButton: getEl('historyButton'),
            historyLog: getEl('historyLog'),
            inputs: {
                inhale: getEl('inhale'),
                holdIn: getEl('holdIn'),
                exhale: getEl('exhale'),
                holdOut: getEl('holdOut')
            }
        };

        // --- App State ---
        let state = {
            isRunning: false,
            audioEnabled: false,
            currentPracticeMode: 'cycles',
            currentPreset: 'extendedExhale',
            userId: null,
            isAuthReady: false
        };

        let timers = { breathCycle: null, countdown: null, session: null, instruction: null };
        
        // Use Temporal API if available (via polyfill), otherwise fallback to Date.now()
        const Temporal = window.Temporal || globalThis.Temporal;
        const getNowMs = () => {
            if (Temporal && Temporal.Now && typeof Temporal.Now.instant === 'function') {
                return Temporal.Now.instant().epochMilliseconds;
            }
            return Date.now();
        };
        let sessionEndTime, cyclesRemaining;
        
        const presets = {
            extendedExhale: { name: "Extended Exhale", values: [4, 2, 8, 0], duration: 2, desc: "Promotes calm by making the exhale longer than the inhale." },
            boxBreathing: { name: "Box Breathing", values: [4, 4, 4, 4], duration: 2, desc: "A simple technique to calm stress and improve focus." },
            resonance: { name: "Resonance", values: [5.5, 0, 5.5, 0], duration: 5, desc: "Aims to maximize HRV by breathing at a resonant frequency." },
            vooBreathing: { name: "VOO Breath", values: [4, 1, 8, 0], duration: 3, desc: "Uses sound vibration to stimulate the vagus nerve." },
            physiologicalSigh: { name: "Physiological Sigh", values: [3, 1, 6, 0], duration: 5, desc: "Two inhales (double breath) then a long exhale. Fast stress relief; calms the nervous system." }
        };

        let synth;
        function setupAudio() {
            if (Tone.context.state !== 'running') Tone.context.resume();
            synth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        }

        // --- Firebase (Optional) ---
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        
        let db, auth;
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";

        if (isFirebaseConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    if (user) state.userId = user.uid;
                    else signInAnonymously(auth).catch(e => console.error("Sign-in failed", e));
                    state.isAuthReady = true;
                    fetchHistory();
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e.message);
                UIElements.historySection.innerHTML = `<p class="text-red-500 text-sm">Practice Log disabled due to Firebase error.</p>`;
            }
        } else {
            console.log("Firebase not configured. Practice Log is disabled.");
            UIElements.historySection.innerHTML = `<p class="text-sm">Practice Log disabled. Add Firebase config to enable.</p>`;
        }

        function applyPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;
            state.currentPreset = presetName;
            const [inhale, holdIn, exhale, holdOut] = preset.values;
            UIElements.inputs.inhale.value = inhale;
            UIElements.inputs.holdIn.value = holdIn;
            UIElements.inputs.exhale.value = exhale;
            UIElements.inputs.holdOut.value = holdOut;
            UIElements.durationInput.value = preset.duration;
            UIElements.presetDescription.textContent = preset.desc;
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.preset === presetName));
        }

        function startBreathing() {
            if (state.isRunning) return;
            state.isRunning = true;
            updateUIForState(true);
            let currentPhaseIndex = -1;
            if (state.currentPracticeMode === 'time') {
                sessionEndTime = getNowMs() + parseFloat(UIElements.durationInput.value) * 60000;
                timers.session = setInterval(checkSessionTime, 1000);
            } else {
                cyclesRemaining = parseInt(UIElements.durationInput.value, 10);
                UIElements.sessionTimeDisplay.textContent = `${cyclesRemaining} cycles remaining`;
            }
            
            // Initial state for animation
            UIElements.circleFill.style.transform = 'scale(0.3)';

            const cyclePhases = [
                { name: 'Inhale', duration: UIElements.inputs.inhale.value, scale: 1.0, className: 'phase-inhale', note: 'C5' },
                { name: 'Hold', duration: UIElements.inputs.holdIn.value, scale: 1.0, className: 'phase-hold-in', note: null },
                { name: 'Exhale', duration: UIElements.inputs.exhale.value, scale: 0.3, className: 'phase-exhale', note: 'C4' },
                { name: 'Hold', duration: UIElements.inputs.holdOut.value, scale: 0.3, className: 'phase-hold-out', note: null }
            ];

            let nextPhaseTime = getNowMs();

            function runNextPhase() {
                if (!state.isRunning) return;
                currentPhaseIndex = (currentPhaseIndex + 1) % cyclePhases.length;
                const phase = cyclePhases[currentPhaseIndex];
                
                // Skip 0-duration phases
                if (phase.duration <= 0) {
                    if (currentPhaseIndex === 3) handleCycleEnd();
                    runNextPhase(); return;
                }

                // Text Transition - track timeout so it can be cancelled on stop
                UIElements.instruction.style.opacity = 0;
                clearTimeout(timers.instruction);
                timers.instruction = setTimeout(() => {
                    if (!state.isRunning) return; // Guard against orphaned callback
                    UIElements.instruction.textContent = phase.name;
                    UIElements.instruction.style.opacity = 1;
                }, 200);

                // Circle Animation
                const COLOR_TRANSITION_DURATION_S = 1;
                UIElements.circleFill.style.transition = `transform ${phase.duration}s linear, background-color ${COLOR_TRANSITION_DURATION_S}s ease`;
                UIElements.circleFill.className = `absolute inset-0 z-0 ${phase.className}`;
                UIElements.circleFill.style.transform = `scale(${phase.scale})`;

                if (state.audioEnabled && phase.note && synth) synth.triggerAttackRelease(phase.note, "8n", Tone.now());
                
                let countdown = parseFloat(phase.duration);
                UIElements.timer.textContent = Math.ceil(countdown);
                clearInterval(timers.countdown);
                timers.countdown = setInterval(() => {
                    countdown -= 1;
                    if(countdown > 0) UIElements.timer.textContent = Math.ceil(countdown);
                }, 1000);
                
                // Drift correction using Temporal-based timestamps
                nextPhaseTime += phase.duration * 1000;
                let delay = nextPhaseTime - getNowMs();
                if (delay < -100) {
                     nextPhaseTime = getNowMs() + phase.duration * 1000;
                     delay = phase.duration * 1000;
                }

                timers.breathCycle = setTimeout(() => {
                    if (currentPhaseIndex === 3) handleCycleEnd();
                    runNextPhase();
                }, Math.max(0, delay));
            }
            nextPhaseTime = getNowMs();
            runNextPhase();
        }
        
        function stopBreathing(isSessionComplete = false) {
            if (isSessionComplete) logSession();
            state.isRunning = false;
            // Clear all timers (both interval and timeout types)
            Object.keys(timers).forEach(key => {
                clearTimeout(timers[key]);
                clearInterval(timers[key]);
                timers[key] = null;
            });
            updateUIForState(false);
            UIElements.instruction.textContent = isSessionComplete ? 'Complete!' : 'Ready?';
        }

        function handleCycleEnd() {
            if (state.currentPracticeMode === 'cycles') {
                cyclesRemaining--;
                if (cyclesRemaining > 0) UIElements.sessionTimeDisplay.textContent = `${cyclesRemaining} cycles remaining`;
                else stopBreathing(true);
            }
        }

        function checkSessionTime() {
            const remaining = Math.round((sessionEndTime - getNowMs()) / 1000);
            if (remaining <= 0) stopBreathing(true);
            else UIElements.sessionTimeDisplay.textContent = `Time: ${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}`;
        }

        function updateUIForState(isRunning) {
            UIElements.startButton.classList.toggle('hidden', isRunning);
            UIElements.stopButton.classList.toggle('hidden', !isRunning);
            const elementsToToggle = [UIElements.settings, UIElements.presetsDiv, UIElements.practiceMode, UIElements.durationInput, UIElements.themeSelector, UIElements.audioToggle];
            elementsToToggle.forEach(el => {
                el.classList.toggle('opacity-50', isRunning);
                el.classList.toggle('pointer-events-none', isRunning);
            });
            if (!isRunning) {
                UIElements.circleFill.style.transition = 'transform 0.5s ease-out';
                UIElements.circleFill.className = 'absolute inset-0 z-0'; // Reset classes
                UIElements.circleFill.style.transform = 'scale(0.3)';
                UIElements.timer.textContent = '-';
                UIElements.sessionTimeDisplay.textContent = '';
                UIElements.instruction.style.opacity = 1;
            }
        }

        UIElements.practiceMode.addEventListener('change', (e) => {
            state.currentPracticeMode = e.target.value;
            UIElements.durationLabel.textContent = e.target.value === 'time' ? 'Duration (min)' : 'Number of Cycles';
        });
        UIElements.audioToggle.addEventListener('click', () => {
            state.audioEnabled = !state.audioEnabled;
            UIElements.audioToggle.textContent = state.audioEnabled ? 'ON' : 'OFF';
            UIElements.audioToggle.setAttribute('aria-pressed', state.audioEnabled);
            UIElements.audioToggle.classList.toggle('btn-primary', state.audioEnabled);
            if (state.audioEnabled && !synth) setupAudio();
        });
        UIElements.themeSelector.addEventListener('change', (e) => {
            const theme = e.target.value;
            UIElements.body.className = theme === 'default' ? '' : theme;
            localStorage.setItem('theme', theme);
        });
        UIElements.historyButton.addEventListener('click', () => {
            const isExpanded = !UIElements.historyLog.classList.toggle('hidden');
            UIElements.historyButton.setAttribute('aria-expanded', isExpanded);
        });
        UIElements.startButton.addEventListener('click', startBreathing);
        UIElements.stopButton.addEventListener('click', () => stopBreathing(false));
        UIElements.presetsDiv.addEventListener('click', (e) => { if (e.target.dataset.preset) applyPreset(e.target.dataset.preset) });

        async function logSession() {
            if (!isFirebaseConfigured || !state.isAuthReady || !state.userId || !db) return;
            const sessionData = {
                technique: presets[state.currentPreset].name,
                mode: state.currentPracticeMode,
                value: UIElements.durationInput.value,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, `users/${state.userId}/sessions`), sessionData);
            } catch (e) { console.error("Error writing to Firestore: ", e) }
        }
        
        function fetchHistory() {
            if (!isFirebaseConfigured || !state.isAuthReady || !state.userId || !db) return;
            const q = query(collection(db, `users/${state.userId}/sessions`), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    UIElements.historyLog.innerHTML = '<p>No sessions recorded yet.</p>'; return;
                }
                UIElements.historyLog.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : '...';
                    const unit = data.mode === 'time' ? 'min' : 'cycles';
                    const logEntry = document.createElement('div');
                    logEntry.className = 'p-2 bg-white/20 rounded';
                    logEntry.textContent = `${date}: ${data.technique} - ${data.value} ${unit}`;
                    UIElements.historyLog.appendChild(logEntry);
                });
            }, error => {
                console.error("Error fetching history: ", error);
                UIElements.historyLog.innerHTML = `<p class="text-red-500">Could not load history.</p>`;
            });
        }
        
        window.onload = () => {
            // Load theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                UIElements.themeSelector.value = savedTheme;
                UIElements.body.className = savedTheme === 'default' ? '' : savedTheme;
            }

            applyPreset('extendedExhale');
            
            // Ensure UI matches default 'cycles' mode
            UIElements.practiceMode.value = state.currentPracticeMode;
            UIElements.durationLabel.textContent = state.currentPracticeMode === 'time' ? 'Duration (min)' : 'Number of Cycles';
            
            updateUIForState(false);
        };
    </script>
</body>
</html>
